#!/bin/bash

#
# mirrorselect: select the fastest mirror from a list!
# Copyright (C) 2010 Semplice Team. All rights reserved.
# This script is released under the terms of the GNU GPL license, version 3 or later.
#

semplice_list="/usr/share/semplice-utilities/mirrorselect/semplice.list"
semplice_sources="/etc/apt/sources.list.d/semplice.list"

VERSION="0.1"
INTERACTIVE="y"
SET="semplice"

error() {
  echo -e "\033[1;31m$1\033[m" >&2
  if [ -z "$2" ]; then
   exit 1
  else
   exit $2
  fi
}


help() {
	echo "$0 <option>- Checks which mirror is the fastest."
	echo ""
	echo "Available arguments:"
	echo "	-s <set>	- Currently only 'semplice', which is the default."
	echo "	-n			- Non-interactive."
	echo "  -h|--help	- This message"
	echo "	-v			- Displays the version."
	echo -e "\nBugs to: launchpad.net/semplice"
}

semplice_parse() {
	# The mirrors are written in a local file. No need to parse it.
	if [ ! -e "$semplice_list" ]; then
		error "The mirror list ($semplice_list) doesn't exists. Aborting."
	fi
	list="`cat $semplice_list`"
	sources="$semplice_sources"
}

do_test() {
	if [ ! -e "$sources" ]; then
		error "The sources file ($sources) doesn't exist. Aborting."
	fi
	
	if [ "$INTERACTIVE" ]; then
		read -p "This will overwrite $sources. You really want to continue? [y/n]: " scelta
		if [ "$scelta" = "n" ]; then
			exit 0
		elif [ "$scelta" != "y" ]; then
			error "You must use y or n."
		fi
	fi
	
	# The mirrors should be in one line...
	for mirror in $list; do
		mirror_list="$mirror_list $mirror"
	done
	
	res="`netselect -v $mirror_list`"
	if [ "$?" != "0" ]; then
		error "netselect encountred an error. Exiting."
	fi
	
	result="`echo $res | awk '{ print $2 }'`"
	
	echo "This is the fastest mirror: $result"
	echo "Re-generating $sources..." # Must add support for debian too!
	cat > $sources <<EOF
# Semplice Linux archive mirror list, generated by mirrorselect $VERSION
deb $result/project/semplice-linux/repo rocks main
EOF
	echo "Generation done. Refreshing pacakge database..."
	apt-get update
	if [ "$?" != "0" ]; then
		error "apt-get update encountred an error."
	fi
	echo "Done. Enjoy your new mirror!"
}

parseargs() {
	for arg in "$@"; do
		case "$1" in
			-s)
				shift
				SET="$1"
				shift;;
			-n)
				shift
				INTERACTIVE="n";;
			-h|--help)
				help
				exit 0;;
			-v)
				echo "mirrorselect version $VERSION"
				exit 0;;
			*)
				rej="$rej $1"
				shift;;
		esac
	done
	_rej=${rej//" "/""}
	if [ "$_rej" ]; then
		echo "Illegal option(s):$rej"
		help
		exit 1
	fi
}

parseargs "$@"

if [ "$USER" != "root" ]; then
	error "You must be root to use mirrorselect."
fi

# Begin...
if [ "$SET" = "semplice" ]; then
	semplice_parse
else
	error "Set $SET not supported. Aborting."
fi

do_test
exit 0
